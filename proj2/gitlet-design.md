# Gitlet Design Document

**Name**: vv

## Classes and Data Structures

### Stage

Represents a staging area.

#### Fields

1. `HashMap<String, String> added`:  <file name, blob's id>.
2. `HashSet<String> removed`:  <file name>.

### Blob

Represent a file.

#### Fields

1. `String filename`: relative path for CWD.
2. `byte[] content`: `Utils.readContents(new File(filename))`.
3. `String uid`: `Utils.sha1(filename, content)`.

#### sha1
filename + content && filename + contentString(`Utils.readContentsAsString(file)`) have the same sha1.
When finding a Sting parameter, `Utils.sha1` will convert it to a byte[]. 
As a result, content & contentString share the same sha1.
Also, they can be converted as below:  
```
content = contentString.getBytes(StandardCharsets.UTF_8);
contentString = new String(content, StandardCharsets.UTF_8);
```

### Commit
Represent a commit.

#### Fields

1. `String message`: commit msg from user input, commit <msg>.
2. `Date timestamp`: time when commit are created, generated by Constructor.
3. `List<String> parents`: parents' commit id.
4. `Map<String, String> Blobs`: <filename, blob's id>, tracking files.
5. `String uid`: `Utils.sha1(message, timestamp.toString(), parents.toString(), blobs.toString())`.

## Algorithms

### commit

+ Create a new commit, with user input message, timestamp when it's created, parentId, tacking files.
+ blobs should inherit from its parents, also with files in staging area, update the added and del the removed.
+ move all blob files in staging directory to blobs directory. Re-instantiate the stage object. aka, clear the stage. and write it back to the stage file.
+ change the tips of the branch, the content of master file. HEAD does not need to move since the file just store the path of the tips of branch.
+ `Each commit is identified by its SHA-1 id, which must include the file (blob) references of its files, parent reference, log message, and commit time.`



### merge

| filename | content in LCA | content in HEAD | content in other | content in result | using    | NO.  |
| -------- | -------------- | --------------- | ---------------- | ----------------- | -------- | ---- |
| a        | A              | A               | !A               | !A                | other    | ①    |
| d        | D              | D               | null             | null              | other    | ⑥    |
| f        | null           | null            | !F               | !F                | other    | ⑤    |
| b        | B              | !B              | B                | !B                | HEAD     | ②    |
| e        | E              | null            | E                | null              | HEAD     | ⑦    |
| g        | null           | G               | null             | G                 | HEAD     | ④    |
| c        | C              | null            | null             | null              | head     | ③a   |
| c        | C/null         | !C              | !C               | !C                | head     | ③a   |
| c        | C              | !C              | &C               |                   | conflict | ③b   |
| c        | C              | !C              | null             |                   | conflict | ③b   |
| c        | C              | null            | !C               |                   | conflict | ③b   |
| c        | null           | !C              | &C               |                   | conflict | ③b   |



+ `h==o`: remain

+ `h!=o`:
  + `l==o`: remain
  + `l==h`: using other 
    + `other!= ""`: rewrite file, and stage as added
    + `other == ""`: stage as removed
  + `l!=o` &&`l!=h`: conflict

## Persistence

```
.gitlet
	-- staging
	-- [stage]
	-- blobs
	-- commits
	-- refs
		-- heads -> [master][branch name]
	-- [HEAD]
```

+ `staging` directory : stores staged(added) blob file; name is blob id, content is the Blob object.  
+ `stage` file: stores Stage object.
+ `blobs` directory: stores all tracked(committed) file; name is blob id, content is the Blob object.  
+ `commits` directory: stores all commits; name is commit id, content is the Commit object.  
+ `head` directory in `refs` : stores different branch; name is branch name, content is the commit id on the tip of the branch.
+ `HEAD` file: stores current branch's name if it points to tip.